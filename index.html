<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitSol | Real-Time Verification</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

    <style>
        :root {
            --primary: #9945FF;
            --secondary: #14F195;
            --dark: #121212;
            --card: #1E1E1E;
            --text: #FFFFFF;
            --gray: #A0A0A0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--dark); 
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container { max-width: 600px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }

        .logo { font-weight: 700; font-size: 1.5rem; letter-spacing: -1px; }
        .logo span { color: var(--secondary); }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h2 { margin-bottom: 20px; font-size: 1.2rem; }

        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            background: #2A2A2A;
            color: white;
            font-size: 1rem;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: var(--dark); margin-top: 10px; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .screen { display: none; }
        .active { display: block; }

        /* QR Section */
        .qr-wrapper {
            background: white;
            padding: 15px;
            border-radius: 15px;
            display: inline-block;
            margin: 15px 0;
        }

        .friend-card {
            border: 1px solid #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            transition: 0.3s;
        }

        .friend-card.paid {
            border-color: var(--secondary);
            background: rgba(20, 241, 149, 0.1);
        }

        .status-tag {
            font-size: 0.7rem;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 20px;
            background: #333;
            font-weight: 700;
        }

        .paid .status-tag { background: var(--secondary); color: var(--dark); }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">SPLIT<span>SOL</span></div>
        <div id="connection-status" style="font-size: 0.8rem; color: var(--secondary);">Devnet Active</div>
    </header>

    <div id="step-1" class="screen active">
        <div class="card">
            <h2>1. Expense Details</h2>
            <input type="text" id="bill-name" placeholder="Dinner at Nobu">
            <input type="number" id="total-amount" placeholder="Total SOL (e.g. 0.5)">
        </div>

        <div class="card">
            <h2>2. Friends (Wallet Addresses)</h2>
            <div id="friend-inputs">
                <input type="text" class="friend-addr" placeholder="Enter Wallet Address">
            </div>
            <button class="btn btn-secondary" onclick="addFriendField()" style="font-size: 0.8rem; padding: 10px;">+ Add Friend</button>
        </div>

        <button class="btn btn-primary" onclick="generateSplit()">Generate Payment Requests</button>
    </div>

    <div id="step-2" class="screen">
        <button onclick="resetApp()" style="background: none; border: none; color: var(--gray); cursor: pointer; margin-bottom: 20px;">‚Üê Back to edit</button>
        <div id="qr-container"></div>
    </div>
</div>

<script>
    // Initialize Solana Connection
    const connection = new solanaWeb3.Connection("https://api.devnet.solana.com", "confirmed");
    
    let activeRequests = [];

    function addFriendField() {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'friend-addr';
        input.placeholder = 'Enter Wallet Address';
        document.getElementById('friend-inputs').appendChild(input);
    }

    function resetApp() {
        document.getElementById('step-2').classList.remove('active');
        document.getElementById('step-1').classList.add('active');
        activeRequests = [];
    }

    async function generateSplit() {
        const name = document.getElementById('bill-name').value;
        const total = parseFloat(document.getElementById('total-amount').value);
        const addrs = Array.from(document.querySelectorAll('.friend-addr')).map(i => i.value.trim()).filter(v => v);

        if (!name || !total || addrs.length === 0) {
            alert("Please fill in all fields.");
            return;
        }

        const perPerson = (total / addrs.length).toFixed(4);
        const container = document.getElementById('qr-container');
        container.innerHTML = `<h2>Splitting: ${name}</h2><p style="color:var(--gray); margin-bottom:20px;">${perPerson} SOL per person</p>`;

        document.getElementById('step-1').classList.remove('active');
        document.getElementById('step-2').classList.add('active');

        addrs.forEach((addr, index) => {
            // Generate a unique Reference Key for this specific person's payment
            const reference = solanaWeb3.Keypair.generate().publicKey;
            
            activeRequests.push({
                address: addr,
                amount: perPerson,
                reference: reference.toString(),
                status: 'pending'
            });

            const card = document.createElement('div');
            card.className = 'friend-card';
            card.id = `card-${index}`;
            
            // Solana Pay URL format
            const solanaUrl = `solana:${addr}?amount=${perPerson}&reference=${reference.toString()}&label=SplitSol&message=${encodeURIComponent(name)}`;

            card.innerHTML = `
                <div class="status-tag" id="status-${index}">Unpaid</div>
                <div class="qr-wrapper" id="qr-${index}"></div>
                <p style="font-size: 0.8rem; font-family: monospace;">${addr.slice(0,4)}...${addr.slice(-4)}</p>
                <button class="btn btn-secondary" id="btn-${index}" onclick="verify('${reference.toString()}', ${index})">Verify Payment</button>
            `;
            container.appendChild(card);

            new QRCode(document.getElementById(`qr-${index}`), {
                text: solanaUrl,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });
    }

    async function verify(referenceStr, index) {
        const btn = document.getElementById(`btn-${index}`);
        const status = document.getElementById(`status-${index}`);
        const card = document.getElementById(`card-${index}`);
        
        btn.disabled = true;
        btn.innerHTML = `<span class="loader"></span>Checking Ledger...`;

        try {
            const reference = new solanaWeb3.PublicKey(referenceStr);
            
            // Search for transactions containing our unique reference key
            const signatures = await connection.getSignaturesForAddress(reference, { limit: 10 });

            if (signatures.length > 0) {
                // Payment Found!
                status.innerText = "Confirmed";
                card.classList.add('paid');
                btn.style.display = "none";
                alert("Payment Verified on Blockchain!");
            } else {
                alert("No transaction found yet. Please scan the QR and complete the payment in Phantom first.");
                btn.disabled = false;
                btn.innerText = "Verify Payment";
            }
        } catch (e) {
            console.error(e);
            alert("Verification error. Check console.");
            btn.disabled = false;
            btn.innerText = "Verify Payment";
        }
    }
</script>

</body>
</html>
